<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>東北雪旅 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
            background-color: #F0F4F8; 
            color: #475569;
            -webkit-tap-highlight-color: transparent;
            letter-spacing: 0.05em;
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .banner-mask {
            border-radius: 0 0 40px 40px;
            box-shadow: 0 10px 30px -10px rgba(148, 163, 184, 0.5);
        }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        @keyframes bounce-sm {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        .animate-bounce-sm { animation: bounce-sm 2s infinite; }
    </style>
    <script>
        tailwind.config = {
            theme: { extend: { colors: { 'snow-blue': '#E3F2FD', 'ice-blue': '#90CAF9', 'deep-blue': '#3B82F6', 'warm-gray': '#64748B', 'accent-red': '#F472B6' } } }
        }
    </script>
</head>
<body>

<div id="app" class="pb-24 min-h-screen relative">

    <header class="relative w-full h-[250px] bg-gray-200 banner-mask z-20 overflow-hidden shrink-0">
        <div class="absolute inset-0 bg-cover bg-center" style="background-image: url('Banner5.jpg');"></div>
        <div class="absolute inset-0 bg-gradient-to-b from-black/10 via-transparent to-black/10"></div>
        
        <div class="absolute top-8 right-6 text-white drop-shadow-md text-right">
            <h1 class="text-3xl font-bold tracking-wider">東北雪旅</h1>
            <p class="text-sm opacity-90 mt-1 font-medium bg-black/20 inline-block px-3 py-1 rounded-full backdrop-blur-sm">2026.02.03 - 02.10</p>
        </div>

        <div class="absolute bottom-4 right-4 flex gap-3 z-30">
            <button @click="currentTab = 'schedule'" :class="tabClass('schedule')" class="w-12 h-12 rounded-full flex items-center justify-center shadow-lg transition-all transform hover:scale-110 backdrop-blur-md"><i class="fa-solid fa-map-location-dot text-lg"></i></button>
            <button @click="currentTab = 'info'" :class="tabClass('info')" class="w-12 h-12 rounded-full flex items-center justify-center shadow-lg transition-all transform hover:scale-105 backdrop-blur-md"><i class="fa-solid fa-circle-info text-lg"></i></button>
            <button @click="currentTab = 'shopping'" :class="tabClass('shopping')" class="w-12 h-12 rounded-full flex items-center justify-center shadow-lg transition-all transform hover:scale-105 backdrop-blur-md"><i class="fa-solid fa-basket-shopping text-lg"></i></button>
            <button @click="currentTab = 'expenses'" :class="tabClass('expenses')" class="w-12 h-12 rounded-full flex items-center justify-center shadow-lg transition-all transform hover:scale-105 backdrop-blur-md"><i class="fa-solid fa-yen-sign text-lg"></i></button>
        </div>
    </header>

    <main class="-mt-6 px-4 relative z-10">

        <div v-if="currentTab === 'schedule'" class="space-y-4 fade-in">
            
            <div class="flex overflow-x-auto gap-3 pb-2 scrollbar-hide pt-2">
                <button v-for="(day, index) in days" :key="day.date" @click="selectedDayIndex = index" :class="selectedDayIndex === index ? 'bg-deep-blue text-white shadow-blue-200' : 'bg-white text-gray-400'" class="flex-shrink-0 flex flex-col items-center justify-center w-16 h-20 rounded-2xl shadow-sm transition-all border border-gray-100">
                    <span class="text-xs font-bold">{{ day.weekday }}</span><span class="text-2xl font-bold mt-1">{{ day.dayNum }}</span>
                </button>
            </div>

            <div class="bg-gradient-to-r from-blue-50 to-white p-4 rounded-3xl shadow-sm border border-blue-100 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <i :class="currentWeather.icon" class="text-3xl text-ice-blue animate-bounce-sm"></i>
                    <div><div class="text-xs text-gray-400 font-bold">Weather</div><div class="font-bold text-gray-700 text-lg">{{ currentWeather.temp }}°C <span class="text-xs font-medium text-gray-400">(體感 {{ currentWeather.feel }}°C)</span></div></div>
                </div>
                <div class="text-right"><div class="text-xs text-blue-400 font-bold px-3 py-1 bg-white rounded-full shadow-sm">{{ days[selectedDayIndex].location }}</div></div>
            </div>

            <div class="space-y-0 relative">
                <div class="absolute left-6 top-4 bottom-0 w-0.5 bg-gray-200 z-0 rounded-full"></div>

                <div v-for="(item, index) in currentDayItems" :key="item.id" class="relative z-10 mb-6 group">
                    <div v-if="index > 0 || (index === 0 && item.travelTime)" class="pl-12 py-2 flex items-center gap-2 text-xs text-gray-400 font-medium">
                        <i :class="transportIcon(item.transportType)"></i><span>{{ item.travelTime }}</span>
                    </div>
                    <div v-else-if="index === 0 && !item.travelTime" class="pl-12 py-2 text-xs text-gray-400 font-medium">從住宿出發</div>

                    <div class="flex gap-4 items-start">
                        <div class="w-12 flex-shrink-0 flex flex-col items-center pt-1 bg-F0F4F8">
                            <div :class="getCategoryColor(item.category)" class="w-4 h-4 rounded-full border-4 border-[#F0F4F8] shadow-sm"></div>
                            <div class="text-[10px] font-bold text-gray-400 mt-1">{{ item.startTime }}</div>
                        </div>

                        <div @click="openMap(item.name)" class="flex-grow bg-white rounded-2xl p-4 shadow-sm border border-gray-100 active:scale-95 transition-transform cursor-pointer relative overflow-hidden">
                            <div class="absolute top-0 right-0 px-3 py-1.5 bg-gray-50 text-[10px] font-bold text-gray-400 rounded-bl-2xl">{{ item.category }}</div>
                            
                            <div v-if="item.category === '航班'" class="flex items-center gap-3 mb-2">
                                <i class="fa-solid fa-plane-departure text-ice-blue text-xl"></i><h3 class="font-bold text-lg text-deep-blue">{{ item.name }}</h3>
                            </div>
                            <h3 v-else class="font-bold text-lg text-gray-700 mb-1 flex flex-wrap items-center gap-2">
                                {{ item.name }}
                                <button v-if="item.timetableId" @click.stop="openBusModal(item.timetableId)" class="text-xs bg-deep-blue text-white px-3 py-1 rounded-full flex items-center gap-1 hover:bg-blue-600 shadow-md transition-transform active:scale-95">
                                    <i class="fa-solid fa-bus"></i> 時刻表
                                </button>
                            </h3>
                            
                            <div class="space-y-1 text-sm text-gray-500 font-medium">
                                <div v-if="item.hours"><i class="fa-regular fa-clock w-5 text-center text-xs opacity-70"></i> {{ item.hours }}</div>
                                <div v-if="item.ticket"><i class="fa-solid fa-ticket w-5 text-center text-xs text-accent-red opacity-70"></i> {{ item.ticket }}</div>
                                <div v-if="item.note" class="text-xs mt-2 p-2 bg-blue-50/50 rounded-xl text-gray-500 border-l-4 border-ice-blue">{{ item.note }}</div>
                            </div>

                            <div class="mt-3 flex justify-end gap-2 border-t border-gray-50 pt-2" @click.stop>
                                <button @click="moveItem(index, -1)" v-if="index > 0" class="w-6 h-6 rounded-full bg-gray-100 text-gray-400 text-xs"><i class="fa-solid fa-arrow-up"></i></button>
                                <button @click="moveItem(index, 1)" v-if="index < currentDayItems.length - 1" class="w-6 h-6 rounded-full bg-gray-100 text-gray-400 text-xs"><i class="fa-solid fa-arrow-down"></i></button>
                                <button @click="editItem(item)" class="px-3 py-1 bg-blue-50 text-blue-600 rounded-full text-xs font-bold">編輯</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="relative z-10 pl-12 pb-20">
                    <div class="bg-gradient-to-br from-gray-50 to-white rounded-2xl p-4 border border-gray-100 shadow-sm relative overflow-hidden">
                        <i class="fa-solid fa-quote-left absolute top-2 left-2 text-gray-100 text-4xl -z-0"></i>
                        <h4 class="font-bold text-gray-700 text-sm mb-1 relative z-10 flex items-center gap-2"><i class="fa-solid fa-map-pin text-accent-red"></i> 關於{{ days[selectedDayIndex].location }}</h4>
                        <p class="text-xs text-gray-500 leading-relaxed relative z-10 text-justify">{{ days[selectedDayIndex].intro }}</p>
                    </div>
                </div>
            </div>
            
            <button @click="openAddModal" class="fixed bottom-6 right-6 w-14 h-14 bg-deep-blue text-white rounded-full shadow-2xl flex items-center justify-center text-2xl z-40 hover:scale-110 transition active:scale-95"><i class="fa-solid fa-plus"></i></button>
        </div>

        <div v-if="currentTab === 'info'" class="space-y-6 pt-4 pb-20 fade-in">
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-700 mb-3 flex items-center"><i class="fa-solid fa-calculator mr-2 text-ice-blue"></i> 匯率小幫手</h3>
                <div class="flex gap-2 items-center">
                    <div class="flex-1"><label class="text-xs text-gray-400 font-bold ml-1">日幣 (JPY)</label><input type="number" v-model="calcJpy" class="w-full bg-gray-50 p-3 rounded-2xl border-none text-lg font-bold text-gray-700" placeholder="¥"></div>
                    <i class="fa-solid fa-arrow-right text-gray-300 mt-5"></i>
                    <div class="flex-1"><label class="text-xs text-gray-400 font-bold ml-1">台幣 (TWD)</label><div class="w-full bg-blue-50 p-3 rounded-2xl border border-blue-100 text-lg font-bold text-deep-blue">${{ (calcJpy * rate).toFixed(0) }}</div></div>
                </div>
            </div>

            <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-700 mb-3 flex items-center"><i class="fa-solid fa-plane mr-2 text-ice-blue"></i> 航班資訊</h3>
                <div class="space-y-4">
                    <div v-for="flight in flights" class="border-l-4 border-ice-blue pl-4 py-1">
                        <div class="flex justify-between items-center mb-1"><span class="text-xs font-bold bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">{{ flight.type }}</span><span class="text-xs font-bold text-gray-400 tracking-wider">{{ flight.code }}</span></div>
                        <div class="font-bold text-gray-700 text-lg">{{ flight.route }}</div><div class="text-sm text-gray-500 font-medium">{{ flight.time }}</div><div class="text-xs text-gray-400 mt-1 font-medium">{{ flight.terminal }}</div>
                    </div>
                </div>
            </div>

            <a href="https://www.navitime.co.jp/zh-tw/transfer/" target="_blank" class="block bg-green-500 text-white p-4 rounded-2xl shadow-md flex items-center justify-between active:scale-95 transition">
                <div class="flex items-center gap-3"><i class="fa-solid fa-train text-xl"></i><span class="font-bold tracking-wide">乘換案內 (NAVITIME)</span></div><i class="fa-solid fa-chevron-right opacity-50"></i>
            </a>

            <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-700 mb-3 flex items-center"><i class="fa-solid fa-language mr-2 text-ice-blue"></i> 日本地名對照</h3>
                <div class="grid grid-cols-2 gap-3">
                    <div v-for="place in locationGlossary" class="bg-gray-50 p-2 rounded-xl flex flex-col items-center justify-center text-center"><div class="font-bold text-gray-700">{{ place.name }}</div><div class="text-xs text-gray-400 font-mono mt-0.5">{{ place.romaji }}</div></div>
                </div>
            </div>

            <div class="space-y-3">
                <h3 class="font-bold text-gray-500 pl-2 text-sm">住宿資訊</h3>
                <div v-for="hotel in hotels" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start"><div class="text-xs bg-gray-100 px-2 py-1 rounded-lg text-gray-500 font-bold">{{ hotel.date }}</div><a :href="'https://www.google.com/maps/search/?api=1&query='+hotel.address" target="_blank" class="text-deep-blue bg-blue-50 w-8 h-8 flex items-center justify-center rounded-full"><i class="fa-solid fa-location-arrow"></i></a></div>
                    <div class="font-bold text-gray-800 mt-2 text-lg">{{ hotel.name }}</div><div class="text-xs text-gray-500 mt-1 font-medium">{{ hotel.address }}</div><div class="text-xs text-gray-400 mt-2 font-medium flex items-center"><i class="fa-solid fa-phone mr-2 text-ice-blue"></i> {{ hotel.phone }}</div>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'shopping'" class="pb-20 fade-in pt-4">
            <div class="grid grid-cols-2 gap-4">
                <div v-for="(item, idx) in shoppingList" class="bg-white rounded-2xl overflow-hidden shadow-sm border border-gray-100 relative group">
                    <button @click="removeShoppingItem(idx)" class="absolute top-2 right-2 bg-white/90 rounded-full w-7 h-7 flex items-center justify-center text-red-400 shadow z-10 hover:text-red-600"><i class="fa-solid fa-times"></i></button>
                    <div class="h-36 bg-gray-50 flex items-center justify-center overflow-hidden"><img v-if="item.image" :src="item.image" class="w-full h-full object-cover"><i v-else class="fa-solid fa-image text-gray-200 text-3xl"></i></div>
                    <div class="p-3"><div class="font-bold text-sm text-gray-700 truncate">{{ item.name }}</div></div>
                </div>
            </div>
            <div v-if="shoppingList.length === 0" class="text-center text-gray-300 mt-20"><i class="fa-solid fa-basket-shopping text-5xl mb-3 opacity-30"></i><p class="font-bold">購物清單是空的</p><p class="text-xs mt-1">按右下角 + 開始新增</p></div>
            <button @click="showShopModal = true" class="fixed bottom-6 right-6 w-14 h-14 bg-deep-blue text-white rounded-full shadow-2xl flex items-center justify-center text-2xl z-40 hover:scale-110 transition active:scale-95"><i class="fa-solid fa-plus"></i></button>
        </div>

        <div v-if="currentTab === 'expenses'" class="pb-20 fade-in pt-4 space-y-4">
            <div class="bg-deep-blue text-white p-6 rounded-3xl shadow-lg shadow-blue-200 relative overflow-hidden">
                <div class="absolute -right-6 -top-6 text-white/10 text-[10rem] rotate-12"><i class="fa-solid fa-yen-sign"></i></div>
                <div class="relative z-10"><div class="text-sm opacity-80 font-bold tracking-wide">總花費 (JPY)</div><div class="text-4xl font-bold mt-1 tracking-tight">¥{{ totalExpense.toLocaleString() }}</div><div class="text-xs opacity-60 mt-2 font-medium bg-white/20 inline-block px-2 py-1 rounded-lg">約 TWD {{ (totalExpense * rate).toFixed(0).toLocaleString() }}</div></div>
            </div>
            <div class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden px-2">
                <div v-for="(exp, idx) in sortedExpenses" :key="idx" class="p-4 border-b border-gray-50 flex justify-between items-center last:border-0">
                    <div class="flex items-center gap-4"><div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-lg text-blue-400"><i :class="getExpenseIcon(exp.category)"></i></div><div><div class="font-bold text-gray-700 text-sm">{{ exp.name }}</div><div class="text-xs text-gray-400 font-medium mt-0.5">{{ exp.date }} · {{ exp.payment }}</div></div></div>
                    <div class="text-right"><div class="font-bold text-gray-800">¥{{ parseInt(exp.amount).toLocaleString() }}</div><button @click="removeExpense(idx)" class="text-xs text-red-300 hover:text-red-500 mt-1 font-bold">刪除</button></div>
                </div>
            </div>
            <button @click="showExpenseModal = true" class="fixed bottom-6 right-6 w-14 h-14 bg-deep-blue text-white rounded-full shadow-2xl flex items-center justify-center text-2xl z-40 hover:scale-110 transition active:scale-95"><i class="fa-solid fa-plus"></i></button>
        </div>

    </main>

    <div v-if="showModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/40 backdrop-blur-sm" @click.self="closeModal">
        <div class="bg-white w-full sm:w-96 rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl animate-slide-up">
            <h3 class="text-xl font-bold mb-4 text-gray-800">{{ isEditing ? '編輯行程' : '新增行程' }}</h3>
            <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-1">
                <select v-model="form.category" class="w-full p-3 bg-gray-50 rounded-2xl border-none font-bold text-gray-700"><option>景點</option><option>住宿</option><option>美食</option><option>購物</option><option>航班</option><option>其他</option></select>
                <input v-model="form.name" placeholder="名稱" class="w-full p-3 bg-gray-50 rounded-2xl border-none font-bold text-gray-700">
                <div class="flex gap-3"><input v-model="form.startTime" type="time" class="w-1/2 p-3 bg-gray-50 rounded-2xl border-none font-bold text-gray-700"><input v-model="form.hours" placeholder="營業時間" class="w-1/2 p-3 bg-gray-50 rounded-2xl border-none font-bold text-gray-700"></div>
                <div class="text-xs text-gray-400 ml-1">進階：時刻表代碼 (如 zao_bus)</div><input v-model="form.timetableId" placeholder="無" class="w-full p-2 bg-gray-50 rounded-xl border-none text-xs text-gray-500">
                <div class="bg-blue-50/50 p-4 rounded-2xl border border-blue-100">
                    <label class="text-xs text-blue-500 font-bold block mb-2">交通方式 (前一站出發)</label>
                    <div class="flex gap-2"><select v-model="form.transportType" class="p-2 text-sm rounded-xl border-none bg-white text-gray-600 font-bold"><option value="walk">步行</option><option value="car">開車</option><option value="transit">大眾運輸</option></select><input v-model="form.travelTime" placeholder="例: 15分" class="flex-1 p-2 text-sm rounded-xl border-none bg-white font-bold text-gray-700"></div>
                </div>
                <input v-model="form.ticket" placeholder="門票" class="w-full p-3 bg-gray-50 rounded-2xl border-none font-bold text-gray-700"><textarea v-model="form.note" placeholder="備註" class="w-full p-3 bg-gray-50 rounded-2xl border-none font-bold text-gray-700 h-20 resize-none"></textarea>
            </div>
            <div class="flex gap-3 mt-6"><button v-if="isEditing" @click="deleteItem" class="flex-1 py-3 rounded-2xl bg-red-50 text-red-500 font-bold">刪除</button><button @click="saveItem" class="flex-[2] py-3 rounded-2xl bg-deep-blue text-white font-bold shadow-lg shadow-blue-200">儲存</button></div>
        </div>
    </div>

    <div v-if="showBusModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm px-4" @click.self="showBusModal = false">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative">
            <button @click="showBusModal = false" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold mb-1 text-center text-gray-800"><i class="fa-solid fa-bus text-deep-blue mr-2"></i>巴士時刻表</h3>
            <p class="text-center text-xs text-gray-400 mb-4">{{ currentBusRoute }}</p>
            <div class="overflow-y-auto max-h-[60vh] rounded-xl border border-gray-100">
                <table class="w-full text-sm text-center"><thead class="bg-blue-50 text-deep-blue font-bold sticky top-0"><tr><th class="py-2">出發</th><th class="py-2">抵達</th></tr></thead><tbody class="divide-y divide-gray-50 text-gray-600"><tr v-for="time in currentBusSchedule" class="odd:bg-white even:bg-gray-50/50"><td class="py-2 font-mono font-bold">{{ time.dep }}</td><td class="py-2 font-mono">{{ time.arr }}</td></tr></tbody></table>
            </div>
            <p class="text-[10px] text-gray-400 mt-3 text-center">*此為預定表，實際以現場為準</p>
        </div>
    </div>

    <div v-if="showShopModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm" @click.self="showShopModal = false"><div class="bg-white w-80 rounded-3xl p-6 shadow-2xl"><h3 class="font-bold text-lg mb-4 text-gray-800">新增購物項目</h3><input v-model="shopForm.name" placeholder="商品名稱" class="w-full p-4 bg-gray-50 rounded-2xl mb-3 border-none font-bold text-gray-700"><label class="block w-full p-6 bg-gray-50 rounded-2xl text-center text-gray-400 cursor-pointer border-2 border-dashed border-gray-200 hover:border-blue-300 transition mb-4"><i class="fa-solid fa-camera mb-2 text-2xl"></i><br><span class="text-xs font-bold">上傳圖片</span><input type="file" @change="handleImageUpload" class="hidden" accept="image/*"></label><div v-if="shopForm.image" class="mb-4 h-24 w-full bg-gray-100 rounded-2xl overflow-hidden border border-gray-100"><img :src="shopForm.image" class="w-full h-full object-cover"></div><button @click="saveShopItem" class="w-full py-3 bg-deep-blue text-white rounded-2xl font-bold shadow-lg shadow-blue-200">加入清單</button></div></div>
    <div v-if="showExpenseModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm" @click.self="showExpenseModal = false"><div class="bg-white w-80 rounded-3xl p-6 shadow-2xl"><h3 class="font-bold text-lg mb-4 text-gray-800">記帳</h3><select v-model="expenseForm.category" class="w-full p-3 mb-2 bg-gray-50 rounded-2xl border-none font-bold text-gray-700"><option>飲食</option><option>交通</option><option>住宿</option><option>門票</option><option>購物</option><option>其他</option></select><input v-model="expenseForm.name" placeholder="項目名稱" class="w-full p-3 mb-2 bg-gray-50 rounded-2xl border-none font-bold text-gray-700"><input v-model="expenseForm.amount" type="number" placeholder="金額 (JPY)" class="w-full p-3 mb-2 bg-gray-50 rounded-2xl border-none font-bold text-gray-700"><div class="flex gap-2 mb-2"><input v-model="expenseForm.date" type="date" class="flex-1 p-3 bg-gray-50 rounded-2xl text-sm font-bold text-gray-600 border-none"><select v-model="expenseForm.payment" class="flex-1 p-3 bg-gray-50 rounded-2xl text-sm font-bold text-gray-600 border-none"><option>現金</option><option>信用卡</option><option>Suica</option></select></div><button @click="saveExpense" class="w-full py-3 bg-deep-blue text-white rounded-2xl font-bold shadow-lg shadow-blue-200">儲存紀錄</button></div></div>

</div>

<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;
    const DATA_VERSION = '2026-v4.0'; // Updated version trigger

    createApp({
        setup() {
            const currentTab = ref('schedule');
            const selectedDayIndex = ref(0);
            const rate = ref(0.22);
            const calcJpy = ref(1000);
            const showModal = ref(false);
            const isEditing = ref(false);
            const editingId = ref(null);
            const showShopModal = ref(false);
            const showExpenseModal = ref(false);
            const showBusModal = ref(false);
            const currentBusSchedule = ref([]);
            const currentBusRoute = ref('');

            const days = [
                { date: '2026-02-03', weekday: 'Tue', dayNum: '3', location: '東京/山形', intro: '藏王溫泉（Zao Onsen）以強酸性硫磺泉聞名，冬季的「樹冰」奇景更是世界級景觀，被稱為「雪怪」。' },
                { date: '2026-02-04', weekday: 'Wed', dayNum: '4', location: '藏王溫泉', intro: '搭乘藏王纜車可俯瞰壯觀的樹冰原。這裡也是滑雪勝地，擁有單板雙板都適合的廣闊雪道。' },
                { date: '2026-02-05', weekday: 'Thu', dayNum: '5', location: '山形/仙台', intro: '仙台是東北購物天堂！從車站連接的 S-PAL、Parco，到著名的 Clis Road 商店街，藥妝、服飾、雜貨應有盡有。午餐必吃善治郎牛舌。' },
                { date: '2026-02-06', weekday: 'Fri', dayNum: '6', location: '銀山溫泉', intro: '銀山溫泉（Ginzan Onsen）保留了大正浪漫時期的木造建築，夜晚煤氣燈亮起時，彷彿進入《神隱少女》的世界。' },
                { date: '2026-02-07', weekday: 'Sat', dayNum: '7', location: '奧入瀨', intro: '奧入瀨溪流（Oirase Gorge）冬季會形成壯觀的冰瀑，星野度假村提供專屬的冰瀑夜遊活動。' },
                { date: '2026-02-08', weekday: 'Sun', dayNum: '8', location: '青森屋', intro: '日本本州最北端的縣，壯麗的自然風光如世界遺產白神山地、十和田湖、奧入瀨溪流、熱鬧的傳統青森睡魔祭和美味的特產蘋果、海鮮、日本酒而聞名，四季分明，擁有獨特的魅力。 ' },
                { date: '2026-02-09', weekday: 'Mon', dayNum: '9', location: '青森屋', intro: '星野青森屋可以完整體驗青森文化，包含著名的「睡魔祭」燈籠裝飾與露天風呂「浮湯」。' },
                { date: '2026-02-10', weekday: 'Tue', dayNum: '10', location: '青森/返台', intro: '旅程終點，可以在青森市區購買蘋果派、蘋果汁等伴手禮。' },
            ];

            const locationGlossary = ref([
                { name: '山形', romaji: 'Yamagata' }, { name: '藏王', romaji: 'Zao' }, { name: '仙台', romaji: 'Sendai' },
                { name: '山寺', romaji: 'Yamadera' },
                { name: '銀山溫泉', romaji: 'Ginzan Onsen' }, { name: '大石田', romaji: 'Oishida' }, { name: '奧入瀨', romaji: 'Oirase' },
                { name: '青森', romaji: 'Aomori' }, { name: '八戶', romaji: 'Hachinohe' }, { name: '三澤', romaji: 'Misawa' },
                { name: '羽田', romaji: 'Haneda' }, { name: '東京', romaji: 'Tokyo' }
            ]);

            const busTimetables = {
                'zao_bus': {
                    route: '山形駅前 - 藏王溫泉',
                    schedule: [ { dep: '12:20', arr: '12:57' }, { dep: '13:20', arr: '13:57' }, { dep: '14:20', arr: '14:57' }, { dep: '15:20', arr: '15:57' }, { dep: '16:20', arr: '16:57' }, { dep: '17:40', arr: '18:17' } ]
                },
                'yamagata_return_bus': {
                    route: '藏王溫泉 - 山形駅前',
                    schedule: [ { dep: '08:40', arr: '09:15' }, { dep: '09:40', arr: '10:15' }, { dep: '10:40', arr: '11:15' }, { dep: '11:40', arr: '12:15' }, { dep: '12:40', arr: '13:15' } ]
                }
            };

            const defaultItinerary = [
                // Day 1: 2/3
                { id: 101, date: '2026-02-03', name: 'IT216 桃園 - 羽田', category: '航班', startTime: '00:10', hours: '00:10-04:00', ticket: '', note: '第三航廈', transportType: '', travelTime: '' },
                { id: 102, date: '2026-02-03', name: '羽田機場換 JR PASS', category: '其他', startTime: '06:00', hours: '', ticket: '', note: '第二航廈旅行服務中心', transportType: 'walk', travelTime: '機場內' },
                { id: 103, date: '2026-02-03', name: '移動至東京車站', category: '交通', startTime: '07:00', hours: '', ticket: 'JR PASS', note: '單軌電車至濱松町轉山手線', transportType: 'transit', travelTime: '40分' },
                { id: 104, date: '2026-02-03', name: 'Tsubasa 129 新幹線', category: '交通', startTime: '08:56', hours: '08:56-11:38', ticket: 'JR PASS', note: '東京 - 山形 (Yamagata)', transportType: 'transit', travelTime: '2.5hr' },
                { id: 105, date: '2026-02-03', name: '山形車站午餐', category: '美食', startTime: '11:40', hours: '', ticket: '', note: '米澤牛便當?', transportType: 'walk', travelTime: '0分' },
                { id: 106, date: '2026-02-03', name: '巴士往藏王溫泉', category: '交通', startTime: '13:20', hours: '', ticket: '1200円', note: '東口巴士總站第一月台', transportType: 'transit', travelTime: '40分', timetableId: 'zao_bus' },
                { id: 107, date: '2026-02-03', name: '高見屋 瑠璃俱樂度假區', category: '住宿', startTime: '15:00', hours: 'Check-in', ticket: '', note: '藏王溫泉 Check-in', transportType: 'walk', travelTime: '10分' },
                
                // Day 2: 2/4
                { id: 201, date: '2026-02-04', name: '藏王樹冰 (Zao Ropeway)', category: '景點', startTime: '09:00', hours: '08:30-17:00', ticket: '3500円', note: '山頂線看樹冰', transportType: 'walk', travelTime: '15分' },
                { id: 202, date: '2026-02-04', name: '溫泉街咖啡 & 散策', category: '美食', startTime: '13:00', hours: '', ticket: '', note: '山口餅屋 (麻糬) / 音茶屋', transportType: 'walk', travelTime: '5分' },
                { id: 203, date: '2026-02-04', name: '藏王大露天風呂', category: '景點', startTime: '15:00', hours: '', ticket: '600円', note: '體驗雪中溫泉 (視開放狀況)', transportType: 'walk', travelTime: '15分' },
                
                // Day 3: 2/5 (Shopping Focused)
                { id: 301, date: '2026-02-05', name: '巴士返回山形車站', category: '交通', startTime: '08:40', hours: '', ticket: '1200円', note: '藏王巴士總站', transportType: 'walk', travelTime: '10分', timetableId: 'yamagata_return_bus' },
                { id: 302, date: '2026-02-05', name: 'JR 往仙台', category: '交通', startTime: '09:30', hours: '', ticket: '', note: '山形 - 仙台 (Sendai) 快速', transportType: 'transit', travelTime: '1hr 15m' },
                { id: 303, date: '2026-02-05', name: 'Richmond Hotel (寄行李)', category: '住宿', startTime: '11:00', hours: '', ticket: '', note: '先至飯店寄放行李', transportType: 'walk', travelTime: '8分' },
                { id: 304, date: '2026-02-05', name: '善治郎牛舌 (Zanjiro)', category: '美食', startTime: '11:30', hours: '', ticket: '', note: '仙台名物！站前本店', transportType: 'walk', travelTime: '5分' },
                { id: 305, date: '2026-02-05', name: '仙台車站大爆買', category: '購物', startTime: '13:00', hours: 'S-PAL / Parco', ticket: '', note: '伴手禮、服飾、雜貨', transportType: 'walk', travelTime: '0分' },
                { id: 306, date: '2026-02-05', name: 'Clis Road 商店街', category: '購物', startTime: '16:00', hours: '', ticket: '', note: '藥妝店激戰區', transportType: 'walk', travelTime: '10分' },
                { id: 307, date: '2026-02-05', name: '回飯店整理 & 寄行李', category: '其他', startTime: '20:00', hours: '', ticket: '', note: '黑貓宅急便寄往星野奧入瀨', transportType: 'walk', travelTime: '10分' },

                // Day 4: 2/6
                { id: 401, date: '2026-02-06', name: '仙台 - 山形 - 大石田', category: '交通', startTime: '10:00', hours: '', ticket: '', note: '轉乘往銀山', transportType: 'transit', travelTime: '1.5hr' },
                { id: 402, date: '2026-02-06', name: '大石田 - 銀山溫泉', category: '交通', startTime: '13:00', hours: '', ticket: '', note: '接駁巴士', transportType: 'transit', travelTime: '40分' },
                { id: 403, date: '2026-02-06', name: '御宿 やなだ屋', category: '住宿', startTime: '15:00', hours: '', ticket: '', note: 'Check-in', transportType: 'walk', travelTime: '5分' },
                { id: 404, date: '2026-02-06', name: '銀山溫泉街夜拍', category: '景點', startTime: '17:30', hours: '', ticket: '', note: '神隱少女場景', transportType: 'walk', travelTime: '0分' },
                // Day 5: 2/7
                { id: 501, date: '2026-02-07', name: '銀山 - 大石田', category: '交通', startTime: '08:25', hours: '08:25-09:01', ticket: '', note: '接駁車', transportType: 'transit', travelTime: '40分' },
                { id: 502, date: '2026-02-07', name: 'Tsubasa 136 往山形', category: '交通', startTime: '09:31', hours: '09:31-10:02', ticket: '', note: '', transportType: 'transit', travelTime: '30分' },
                { id: 503, date: '2026-02-07', name: '山形 - 仙台 - 八戶', category: '交通', startTime: '11:00', hours: '', ticket: '', note: '仙山線快速 + Hayabusa 15', transportType: 'transit', travelTime: '2hr' },
                { id: 504, date: '2026-02-07', name: '八戶車站接駁', category: '交通', startTime: '13:50', hours: '', ticket: '', note: '往奧入瀨', transportType: 'transit', travelTime: '1.5hr' },
                { id: 505, date: '2026-02-07', name: '星野奧入瀨溪流飯店', category: '住宿', startTime: '15:30', hours: '', ticket: '', note: 'Check-in', transportType: 'transit', travelTime: '0分' },
                { id: 506, date: '2026-02-07', name: '青森蘋果廚房', category: '美食', startTime: '19:20', hours: '', ticket: '', note: '晚餐 Buffet', transportType: 'walk', travelTime: '館內' },
                { id: 507, date: '2026-02-07', name: '夜觀冰瀑', category: '景點', startTime: '21:15', hours: '', ticket: '', note: '飯店活動', transportType: 'transit', travelTime: '專車' },
                // Day 6: 2/8
                { id: 601, date: '2026-02-08', name: '蘋果廚房早餐', category: '美食', startTime: '08:30', hours: '', ticket: '', note: '', transportType: 'walk', travelTime: '館內' },
                { id: 602, date: '2026-02-08', name: '奧入瀨溪流 Bus Tour', category: '景點', startTime: '13:25', hours: '', ticket: '', note: '', transportType: 'transit', travelTime: '' },
                { id: 603, date: '2026-02-08', name: '接駁至星野青森屋', category: '交通', startTime: '15:30', hours: '', ticket: '', note: '跨飯店接駁', transportType: 'transit', travelTime: '1hr' },
                { id: 604, date: '2026-02-08', name: 'Noresore 晚餐', category: '美食', startTime: '18:15', hours: '', ticket: '', note: '青森屋自助餐', transportType: 'walk', travelTime: '館內' },
                // Day 7: 2/9
                { id: 701, date: '2026-02-09', name: 'Noresore 早餐', category: '美食', startTime: '08:15', hours: '', ticket: '', note: '', transportType: 'walk', travelTime: '館內' },
                { id: 702, date: '2026-02-09', name: '青森屋設施體驗', category: '景點', startTime: '10:00', hours: '', ticket: '', note: '泡湯、暖爐馬車', transportType: 'walk', travelTime: '' },
                { id: 703, date: '2026-02-09', name: 'Noresore 晚餐', category: '美食', startTime: '18:15', hours: '', ticket: '', note: '', transportType: 'walk', travelTime: '' },
                // Day 8: 2/10
                { id: 801, date: '2026-02-10', name: 'Noresore 早餐', category: '美食', startTime: '07:15', hours: '', ticket: '', note: '', transportType: 'walk', travelTime: '館內' },
                { id: 802, date: '2026-02-10', name: '接駁至三沢駅', category: '交通', startTime: '09:00', hours: '', ticket: '', note: '', transportType: 'transit', travelTime: '20分' },
                { id: 803, date: '2026-02-10', name: '三沢 - 青森', category: '交通', startTime: '09:20', hours: '09:20-10:34', ticket: '', note: '青之森鐵道', transportType: 'transit', travelTime: '1.2hr' },
                { id: 804, date: '2026-02-10', name: '青森 - 青森機場', category: '交通', startTime: '12:30', hours: '12:30-13:05', ticket: '', note: 'JR巴士東北', transportType: 'transit', travelTime: '35分' },
                { id: 805, date: '2026-02-10', name: 'BR121 青森 - 桃園', category: '航班', startTime: '15:30', hours: '15:30-19:00', ticket: '', note: '第一航廈', transportType: 'walk', travelTime: '' }
            ];

            const flights = [
                { type: '去程', code: 'IT216', route: 'TPE - HND', time: '02/03 00:10 - 04:00', terminal: 'TPE T1 / HND T3' },
                { type: '回程', code: 'BR121', route: 'AOJ - TPE', time: '02/10 15:30 - 19:00', terminal: 'AOJ / TPE T2' },
            ];

            const hotels = [
                { name: '高見屋 瑠璃俱樂度假區', phone: '023-610-9602', address: '山形縣山形市藏王溫泉三度川1118-7', date: '2/3-2/4' },
                { name: 'Richmond Hotel Premier', phone: '+81 22-716-2855', address: '仙台市青葉区中央2-1-1', date: '2/5' },
                { name: '御宿 やなだ屋', phone: '0237-28-2030', address: '山形県尾花沢市大字銀山新畑416', date: '2/6' },
                { name: '星野奧入瀨溪流飯店', phone: '+81 50-3134-8094', address: '青森縣十和田市奥瀬栃久保231', date: '2/7' },
                { name: '星野青森屋', phone: '+81 50-3134-8094', address: '青森縣三澤市古間木山56', date: '2/8-2/9' },
            ];

            // Setup Data with Version Check (Silent Update)
            const itineraryItems = ref([]);
            const shoppingList = ref(JSON.parse(localStorage.getItem('trip_shopping')) || []);
            const expenses = ref(JSON.parse(localStorage.getItem('trip_expenses')) || []);

            const storedVersion = localStorage.getItem('data_version');
            if (storedVersion !== DATA_VERSION) {
                console.log('Silent update to ' + DATA_VERSION);
                itineraryItems.value = defaultItinerary;
                localStorage.setItem('trip_itinerary', JSON.stringify(defaultItinerary));
                localStorage.setItem('data_version', DATA_VERSION);
            } else {
                itineraryItems.value = JSON.parse(localStorage.getItem('trip_itinerary')) || defaultItinerary;
            }

            const form = ref({});
            const shopForm = ref({ name: '', image: null });
            const expenseForm = ref({ category: '飲食', name: '', amount: '', date: '', payment: '現金' });

            watch(itineraryItems, (newVal) => localStorage.setItem('trip_itinerary', JSON.stringify(newVal)), { deep: true });
            watch(shoppingList, (newVal) => localStorage.setItem('trip_shopping', JSON.stringify(newVal)), { deep: true });
            watch(expenses, (newVal) => localStorage.setItem('trip_expenses', JSON.stringify(newVal)), { deep: true });

            const currentDayItems = computed(() => {
                const date = days[selectedDayIndex.value].date;
                return itineraryItems.value.filter(i => i.date === date).sort((a, b) => a.startTime.localeCompare(b.startTime));
            });

            const currentWeather = computed(() => {
                const map = [ { icon: 'fa-solid fa-cloud-showers-heavy', temp: -1, feel: -4 }, { icon: 'fa-regular fa-snowflake', temp: -5, feel: -9 }, { icon: 'fa-solid fa-cloud', temp: 2, feel: 0 }, { icon: 'fa-regular fa-snowflake', temp: -3, feel: -6 }, { icon: 'fa-regular fa-snowflake', temp: -4, feel: -8 }, { icon: 'fa-regular fa-snowflake', temp: -2, feel: -5 }, { icon: 'fa-regular fa-snowflake', temp: -2, feel: -5 }, { icon: 'fa-solid fa-sun', temp: 1, feel: -2 } ];
                return map[selectedDayIndex.value] || map[0];
            });

            const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + Number(item.amount), 0));
            const sortedExpenses = computed(() => [...expenses.value].reverse());

            const tabClass = (tab) => currentTab.value === tab ? 'bg-white/90 text-deep-blue border-2 border-white' : 'bg-white/40 text-white border border-white/30';
            const getCategoryColor = (cat) => ({ '景點': 'bg-green-400', '住宿': 'bg-purple-400', '美食': 'bg-orange-400', '購物': 'bg-pink-400', '交通': 'bg-blue-400', '航班': 'bg-blue-600', '其他': 'bg-gray-400' }[cat] || 'bg-gray-400');
            const transportIcon = (type) => ({ 'walk': 'fa-solid fa-person-walking', 'car': 'fa-solid fa-car', 'transit': 'fa-solid fa-train-subway' }[type] || 'fa-solid fa-shoe-prints');
            const getExpenseIcon = (cat) => `fa-solid ` + ({ '飲食': 'fa-utensils', '交通': 'fa-train', '住宿': 'fa-bed', '門票': 'fa-ticket', '購物': 'fa-bag-shopping', '其他': 'fa-circle-question' }[cat] || 'fa-circle');
            
            const openMap = (keyword) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(keyword)}`, '_blank');
            const openAddModal = () => { isEditing.value = false; form.value = { date: days[selectedDayIndex.value].date, category: '景點', name: '', startTime: '', hours: '', ticket: '', note: '', transportType: 'walk', travelTime: '15分', timetableId: '' }; showModal.value = true; };
            const editItem = (item) => { isEditing.value = true; editingId.value = item.id; form.value = JSON.parse(JSON.stringify(item)); showModal.value = true; };
            const saveItem = () => { if (isEditing.value) { const idx = itineraryItems.value.findIndex(i => i.id === editingId.value); if(idx !== -1) itineraryItems.value[idx] = { ...form.value, id: editingId.value }; } else { itineraryItems.value.push({ ...form.value, id: Date.now() }); } showModal.value = false; };
            const deleteItem = () => { if(confirm('確定要刪除嗎？')) { itineraryItems.value = itineraryItems.value.filter(i => i.id !== editingId.value); showModal.value = false; } };
            const moveItem = (index, direction) => { const items = currentDayItems.value; const itemA = items[index]; const itemB = items[index + direction]; const tempTime = itemA.startTime; itemA.startTime = itemB.startTime; itemB.startTime = tempTime; };
            const closeModal = () => showModal.value = false;

            const handleImageUpload = (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => shopForm.value.image = e.target.result; reader.readAsDataURL(file); } };
            const saveShopItem = () => { if(!shopForm.value.name) return; shoppingList.value.push({ ...shopForm.value }); shopForm.value = { name: '', image: null }; showShopModal.value = false; };
            const removeShoppingItem = (idx) => confirm('刪除？') && shoppingList.value.splice(idx, 1);
            
            const saveExpense = () => { if(!expenseForm.value.amount) return; expenses.value.push({ ...expenseForm.value, date: expenseForm.value.date || new Date().toISOString().split('T')[0] }); showExpenseModal.value = false; expenseForm.value = { category: '飲食', name: '', amount: '', date: '', payment: '現金' }; };
            const removeExpense = (idx) => confirm('刪除？') && expenses.value.splice(idx, 1);

            const openBusModal = (timetableId) => { 
                if (busTimetables[timetableId]) { 
                    currentBusSchedule.value = busTimetables[timetableId].schedule; 
                    currentBusRoute.value = busTimetables[timetableId].route;
                    showBusModal.value = true; 
                } 
            };

            onMounted(() => expenseForm.value.date = new Date().toISOString().split('T')[0]);

            return {
                currentTab, days, selectedDayIndex, currentWeather,
                currentDayItems, flights, hotels, shoppingList, expenses, totalExpense, sortedExpenses,
                rate, calcJpy, showModal, isEditing, form, showShopModal, shopForm, showExpenseModal, expenseForm,
                showBusModal, currentBusSchedule, currentBusRoute, locationGlossary,
                tabClass, getCategoryColor, transportIcon, getExpenseIcon,
                openMap, openAddModal, editItem, saveItem, deleteItem, closeModal, moveItem,
                handleImageUpload, saveShopItem, removeShoppingItem, saveExpense, removeExpense, openBusModal
            };
        }
    }).mount('#app');
</script>
</body>
</html>
